<!DOCTYPE html>
<html>
  <head>
    <title>Richarlison Racer - Controller Support</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    
    <script>
      AFRAME.registerComponent('drive-car', {
        init: function () {
          this.speed = 0;
          this.rotationSpeed = 0;
          
          // Estados de controle (Teclado)
          this.keys = {
            up: false,
            down: false,
            left: false,
            right: false
          };

          // Ouvintes do Teclado
          window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = true;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = true;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = true;
          });

          window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = false;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = false;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = false;
          });
        },

        tick: function (time, timeDelta) {
          const rotation = this.el.getAttribute('rotation');
          const position = this.el.getAttribute('position');
          const delta = timeDelta / 1000;

          // --- LÓGICA DO CONTROLE (GAMEPAD) ---
          let gpAccelerate = false;
          let gpBrake = false;
          let gpTurn = 0; // -1 (esquerda) a 1 (direita)

          // Pega os controles conectados
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          // Pega o primeiro controle ativo (index 0)
          const gp = gamepads[0];

          if (gp) {
            // Botão 0 (Geralmente A ou X) para Acelerar
            if (gp.buttons[0].pressed) gpAccelerate = true;
            // Botão 1 (Geralmente B ou Bola) para Freiar
            if (gp.buttons[1].pressed) gpBrake = true;
            // Eixo 0 (Analógico Esquerdo horizontal)
            if (Math.abs(gp.axes[0]) > 0.1) gpTurn = gp.axes[0]; // Zona morta de 0.1
          }

          // --- FÍSICA ---

          // Acelerar (Teclado OU Controle)
          if (this.keys.up || gpAccelerate) {
            this.speed -= 15 * delta; // Aumentei um pouco a potência
          }
          
          // Freiar (Teclado OU Controle)
          if (this.keys.down || gpBrake) {
            this.speed += 15 * delta;
          }

          // Atrito
          this.speed *= 0.95;

          // Curvas (só vira se estiver andando)
          if (Math.abs(this.speed) > 0.1) {
            // Teclado
            if (this.keys.left) this.rotationSpeed += 60 * delta;
            if (this.keys.right) this.rotationSpeed -= 60 * delta;
            
            // Controle (Entrada Analógica deixa a curva mais suave)
            if (gpTurn !== 0) {
              this.rotationSpeed -= gpTurn * 60 * delta;
            }
          }
          
          this.rotationSpeed *= 0.90; // Estabiliza a direção

          // Aplica rotação e posição
          rotation.y += this.rotationSpeed * delta;
          this.el.setAttribute('rotation', rotation);

          const angle = rotation.y * (Math.PI / 180);
          position.x += Math.sin(angle) * this.speed * delta;
          position.z += Math.cos(angle) * this.speed * delta;
          
          this.el.setAttribute('position', position);
        }
      });
    </script>

    <a-scene background="color: #ECECEC">
      
      <a-assets>
        <a-asset-item id="modelo-carro" src="./carro.glb"></a-asset-item>
        <img id="grama" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
      </a-assets>

      <a-plane src="#grama" position="0 0 0" rotation="-90 0 0" width="200" height="200" repeat="20 20"></a-plane>
      <a-sky color="#87CEEB"></a-sky>

      <a-box position="-5 0.5 -10" color="red"></a-box>
      <a-box position="5 0.5 -20" color="blue"></a-box>
      <a-box position="0 0.5 -40" color="yellow"></a-box>

      <a-text value="Conecte o Controle e aperte qualquer botao!" position="-2 3 -5" color="black" align="center"></a-text>

      <a-entity id="player" position="0 0 0" drive-car>
        <a-entity gltf-model="#modelo-carro" scale="1 1 1"></a-entity>
        <a-entity camera position="0 2 5" look-controls="enabled: false"></a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
