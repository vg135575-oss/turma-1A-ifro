<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Richarlison Pro Racer - Mobile Edition</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>

    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            -webkit-user-select: none; /* Previne seleção de texto no celular */
            touch-action: none; /* Previne scroll e zoom acidental no celular */
        }
        body { overflow: hidden; background-color: #000; }

        /* HUD Principal */
        #hud-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1000;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .top-panel {
            display: flex; justify-content: space-between; padding: 10px;
        }

        /* Painel de DEBUG para o seu controle de 20 reais */
        #gamepad-debug {
            background: rgba(255, 0, 0, 0.8); color: white;
            padding: 5px 10px; border-radius: 5px; font-size: 12px;
            font-family: monospace; border: 2px solid white;
            max-width: 150px; word-wrap: break-word;
        }

        .speedometer {
            background: rgba(0, 0, 0, 0.7); color: #00ffcc;
            padding: 10px 20px; border-radius: 8px; font-size: 24px;
            font-weight: bold; border: 2px solid #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }

        /* ========================================= */
        /* CONTROLES TOUCH PARA CELULAR (Virtual Pad) */
        /* ========================================= */
        #touch-controls {
            position: fixed; bottom: 20px; left: 0; width: 100%;
            height: 120px; display: flex; justify-content: space-between;
            padding: 0 20px; z-index: 2000; pointer-events: auto;
        }

        .dpad, .action-buttons {
            display: flex; gap: 10px; align-items: flex-end;
        }

        .touch-btn {
            width: 70px; height: 70px; background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.5); border-radius: 50%;
            color: white; font-size: 24px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .touch-btn:active { background: rgba(0, 255, 204, 0.6); transform: scale(0.9); }
        .touch-btn.wide { width: 90px; border-radius: 20px; }

        #horn-screen {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 60px; color: #ffea00; font-weight: 900;
            text-shadow: 2px 2px 0 #ff0000; opacity: 0; transition: opacity 0.1s;
            z-index: 2000; pointer-events: none;
        }

        #pause-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 3000;
            pointer-events: auto;
        }
        .start-btn {
            background: #ffaa00; color: #000; border: none; padding: 15px 40px;
            font-size: 24px; font-weight: bold; border-radius: 10px;
            cursor: pointer; text-transform: uppercase; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="pause-menu">
        <h1 style="color: white; text-align: center;">Richarlison<br><span style="color: #00ffcc">Mobile Racer</span></h1>
        <p style="color: #aaa; margin-top: 10px; text-align: center; font-size: 14px; padding: 0 20px;">
            Toque nos botões da tela ou conecte seu controle Bluetooth.
        </p>
        <button class="start-btn" onclick="startGame()">Jogar</button>
    </div>

    <div id="horn-screen">BEEP!</div>

    <div id="hud-container">
        <div class="top-panel">
            <div id="gamepad-debug">Controle: Desconectado</div>
            <div class="speedometer"><span id="speed-text">0</span> KM/H</div>
        </div>
    </div>

    <div id="touch-controls" style="display: none;">
        <div class="dpad">
            <div class="touch-btn" id="btn-left">◀</div>
            <div class="touch-btn" id="btn-right">▶</div>
        </div>
        <div class="action-buttons">
            <div class="touch-btn" id="btn-brake">B</div>
            <div class="touch-btn wide" id="btn-accel">Acelerar</div>
        </div>
    </div>

    <script>
        let gameActive = false;

        function startGame() {
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('touch-controls').style.display = 'flex';
            gameActive = true;
            document.querySelector('a-scene').play();
            
            // Tenta colocar em Tela Cheia no celular
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            }
        }

        // ==========================================
        // GERENCIADOR DE INPUT (TOUCH + GENERIC GAMEPAD)
        // ==========================================
        AFRAME.registerComponent('input-manager', {
            init: function () {
                this.axis = { x: 0 }; 
                this.buttons = { accelerate: false, brake: false, horn: false };
                
                // Configuração Touch (Celular)
                this.setupTouchControls();
            },

            setupTouchControls: function() {
                const btnLeft = document.getElementById('btn-left');
                const btnRight = document.getElementById('btn-right');
                const btnAccel = document.getElementById('btn-accel');
                const btnBrake = document.getElementById('btn-brake');

                // Lógica de Direção (Esquerda/Direita)
                const setLeft = (val) => { this.axis.x = val ? -1 : 0; };
                const setRight = (val) => { this.axis.x = val ? 1 : 0; };
                
                btnLeft.addEventListener('touchstart', () => setLeft(true));
                btnLeft.addEventListener('touchend', () => setLeft(false));
                
                btnRight.addEventListener('touchstart', () => setRight(true));
                btnRight.addEventListener('touchend', () => setRight(false));

                // Lógica de Pedais
                btnAccel.addEventListener('touchstart', () => this.buttons.accelerate = true);
                btnAccel.addEventListener('touchend', () => this.buttons.accelerate = false);
                
                btnBrake.addEventListener('touchstart', () => this.buttons.brake = true);
                btnBrake.addEventListener('touchend', () => this.buttons.brake = false);
            },

            tick: function () {
                if (!gameActive) return;

                // Lê o Gamepad
                const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
                const gp = gamepads[0];
                const debugText = document.getElementById('gamepad-debug');
                
                if (gp) {
                    let activeButtons = [];
                    
                    // LÓGICA UNIVERSAL PARA CONTROLES GENÉRICOS
                    // Rastreamos vários botões para a mesma ação para garantir compatibilidade
                    
                    let isAccelerating = false;
                    let isBraking = false;
                    let isHorn = false;

                    for (let i = 0; i < gp.buttons.length; i++) {
                        if (gp.buttons[i].pressed || gp.buttons[i].value > 0.5) {
                            activeButtons.push(i);
                            
                            // Botões comuns de Acelerar: 7(R2), 5(R1), 0(A/X verde)
                            if (i === 7 || i === 5 || i === 0) isAccelerating = true;
                            
                            // Botões comuns de Frear: 6(L2), 4(L1), 1(B/Bola vermelha), 2(X/Quadrado)
                            if (i === 6 || i === 4 || i === 1 || i === 2) isBraking = true;
                            
                            // Buzina: 3(Y/Triângulo), 9(Start), 8(Select)
                            if (i === 3 || i === 9 || i === 8) isHorn = true;
                        }
                    }

                    // Se usar o gamepad, ele sobrescreve o touch
                    if (isAccelerating || isBraking) {
                        this.buttons.accelerate = isAccelerating;
                        this.buttons.brake = isBraking;
                    }
                    this.buttons.horn = isHorn;

                    // Direção (D-pad ou Analógico Esquerdo)
                    // Pega o eixo 0 (Analógico) ou botões 14 e 15 (Setas D-PAD genérico)
                    let eixoX = gp.axes[0];
                    if (Math.abs(eixoX) > 0.2) {
                        this.axis.x = eixoX;
                    } else if (gp.buttons[14] && gp.buttons[14].pressed) {
                        this.axis.x = -1; // Seta Esquerda
                        activeButtons.push("D-Left");
                    } else if (gp.buttons[15] && gp.buttons[15].pressed) {
                        this.axis.x = 1;  // Seta Direita
                        activeButtons.push("D-Right");
                    } else {
                        // Se não estiver tocando na tela, zera o eixo
                        if (!document.getElementById('btn-left').matches(':active') && 
                            !document.getElementById('btn-right').matches(':active')) {
                            this.axis.x = 0;
                        }
                    }

                    // Atualiza Painel de Debug
                    let axisVal = gp.axes[0] ? gp.axes[0].toFixed(1) : 0;
                    debugText.innerText = `Eixo: ${axisVal} | Botões: [${activeButtons.join(',')}]`;
                }
            }
        });

        // ==========================================
        // FÍSICA DO CARRO (Otimizada para Celular)
        // ==========================================
        AFRAME.registerComponent('car-physics', {
            dependencies: ['input-manager'],
            init: function () {
                this.velocity = 0;
                this.steering = 0;
                this.input = this.el.components['input-manager'];
                this.speedText = document.getElementById('speed-text');
                this.hornScreen = document.getElementById('horn-screen');
                this.hornActive = false;
            },
            tick: function (time, delta) {
                if (!gameActive) return;
                const dt = delta / 1000;
                const inp = this.input;

                // Aceleração e Frenagem
                if (inp.buttons.accelerate) this.velocity -= 15 * dt;
                if (inp.buttons.brake) this.velocity += 20 * dt;
                
                // Atrito da pista
                this.velocity *= 0.97;

                // Curva
                let turnSpeed = Math.min(Math.abs(this.velocity) / 5, 1);
                this.steering -= inp.axis.x * 60 * turnSpeed * dt;
                
                // Inverter direção da curva na ré
                if (this.velocity > 0.1) this.steering += inp.axis.x * 120 * turnSpeed * dt; 

                this.steering *= 0.8; // Centralizar volante

                // Aplica rotação e movimento
                let rot = this.el.getAttribute('rotation');
                rot.y += this.steering;
                this.el.setAttribute('rotation', rot);

                let pos = this.el.getAttribute('position');
                pos.x += Math.sin(rot.y * Math.PI/180) * this.velocity * dt;
                pos.z += Math.cos(rot.y * Math.PI/180) * this.velocity * dt;
                this.el.setAttribute('position', pos);

                // HUD e Buzina
                this.speedText.innerText = Math.floor(Math.abs(this.velocity * 8.5));

                if (inp.buttons.horn && !this.hornActive) {
                    this.hornActive = true;
                    this.hornScreen.style.opacity = '1';
                    setTimeout(() => { this.hornScreen.style.opacity = '0'; this.hornActive = false; }, 400);
                }
            }
        });

    </script>

    <a-scene vr-mode-ui="enabled: false" renderer="antialias: false; colorManagement: true; precision: mediump;">
        
        <a-assets>
            <a-asset-item id="modelo-carro" src="./carro.glb"></a-asset-item>
        </a-assets>

        <a-entity environment="preset: contact; groundColor: #222; grid: 1x1; fog: 0.6"></a-entity>
        <a-light type="ambient" color="#fff" intensity="0.5"></a-light>
        <a-light type="directional" position="5 10 -5" intensity="0.5"></a-light>

        <a-entity id="player" position="0 0 0" input-manager car-physics>
            
            <a-entity gltf-model="#modelo-carro" scale="1 1 1" rotation="0 180 0">
                <a-box position="0 1 0" width="1.8" height="0.8" depth="4" color="#ff0000"></a-box>
            </a-entity>

            <a-entity camera position="0 3.5 8" rotation="-15 0 0"></a-entity>
        </a-entity>

        <a-cylinder position="-5 1 -20" color="#ffaa00" radius="1" height="2"></a-cylinder>
        <a-cylinder position="5 1 -40" color="#00ffcc" radius="1" height="2"></a-cylinder>
        <a-box position="0 2 -80" color="#ff0000" width="10" height="4" depth="1"></a-box>

    </a-scene>

</body>
</html>
