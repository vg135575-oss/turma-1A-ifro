<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Corrida Infinita</title>

<style>
body{margin:0;overflow:hidden;background:black}
#hud{
position:absolute;
top:10px;
left:10px;
color:white;
font-family:sans-serif;
}
</style>
</head>

<body>
<div id="hud">Toque esquerda / direita</div>

<script type="module">

import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.154.0/examples/jsm/loaders/GLTFLoader.js';

let scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x202020,10,120);

let camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,400);
camera.position.set(0,3,8);

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1));

let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(-3,10,5);
scene.add(light);

///// Estrada

let canvas = document.createElement('canvas');
canvas.width=512;
canvas.height=512;
let ctx = canvas.getContext('2d');

function drawRoad(){
ctx.fillStyle="#2b2b2b";
ctx.fillRect(0,0,512,512);

ctx.fillStyle="white";
for(let y=0;y<512;y+=120){
ctx.fillRect(256-6,y,12,40);
}
}
drawRoad();

let roadTexture = new THREE.CanvasTexture(canvas);
roadTexture.wrapT = THREE.RepeatWrapping;
roadTexture.repeat.set(1,30);

let road = new THREE.Mesh(
new THREE.PlaneGeometry(6,200),
new THREE.MeshLambertMaterial({map:roadTexture})
);
road.rotation.x = -Math.PI/2;
scene.add(road);

///// CARRO

let car;
let loader = new GLTFLoader();

loader.load("carro.glb",(gltf)=>{
car = gltf.scene;
car.scale.set(1,1,1);
car.position.y = 0.2;
scene.add(car);
});

//// ObstÃ¡culos

let obstacles=[];

function spawnObstacle(){
let box = new THREE.Mesh(
new THREE.BoxGeometry(1,1,1),
new THREE.MeshStandardMaterial({color:0xff0000})
);

let lanes=[-2,0,2];
box.position.set(lanes[Math.floor(Math.random()*3)],0.5,-80);

scene.add(box);
obstacles.push(box);
}

//// Controles

let lanes=[-2,0,2];
let lane=1;

addEventListener("touchstart",(e)=>{
if(e.touches[0].clientX < innerWidth/2){
lane=Math.max(0,lane-1);
}else{
lane=Math.min(2,lane+1);
}
});

//// Loop

let last=0;
let spawnTimer=0;

function animate(t){

requestAnimationFrame(animate);

let dt=(t-last)/1000;
last=t;

roadTexture.offset.y -= dt*2;

spawnTimer+=dt;
if(spawnTimer>1){
spawnTimer=0;
spawnObstacle();
}

if(car){
car.position.x += (lanes[lane]-car.position.x)*10*dt;

camera.position.x = car.position.x;
camera.lookAt(car.position);
}

obstacles.forEach(o=>{
o.position.z += 12*dt;

if(car){
let a=new THREE.Box3().setFromObject(car);
let b=new THREE.Box3().setFromObject(o);

if(a.intersectsBox(b)){
alert("Game Over");
location.reload();
}
}
});

renderer.render(scene,camera);
}

animate();

onresize=()=>{
camera.aspect=innerWidth/innerHeight;
camera.updateProjectionMatrix();
renderer.setSize(innerWidth,innerHeight);
}

</script>
</body>
</html>
