<!DOCTYPE html>
<html>
  <head>
    <title>Richarlison Pro Racer</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    
    <script>
      AFRAME.registerComponent('drive-car', {
        init: function () {
          this.speed = 0;
          this.rotationSpeed = 0;
          this.camRotationY = 0; 
          this.camRotationX = -15; 
          this.hornTimeout = null;
        },

        tick: function (time, timeDelta) {
          const delta = timeDelta / 1000;
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          const gp = gamepads[0];
          const hornEl = document.querySelector('#horn-ui');

          if (gp) {
            // --- 1. CONTROLES DE MOVIMENTO (Analógico Esquerdo + Gatilhos) ---
            let accelerate = (gp.buttons[7].value > 0.1) || (gp.axes[1] < -0.2); // R2 ou Analógico Cima
            let brake = (gp.buttons[6].value > 0.1) || (gp.axes[1] > 0.2);      // L2 ou Analógico Baixo
            let turnInput = gp.axes[0]; // Analógico Esquerdo Horizontal

            // Funções de Botões Extras
            if (gp.buttons[2].pressed) this.speed = 0; // Botão X / Quadrado: Freio de mão
            if (gp.buttons[3].pressed) { // Botão Y / Triângulo: Reset Camera
                this.camRotationY = 0;
                this.camRotationX = -15;
            }
            if (gp.buttons[0].pressed) { // Botão A / Cruz: Buzina
                hornEl.setAttribute('visible', 'true');
                if(this.hornTimeout) clearTimeout(this.hornTimeout);
                this.hornTimeout = setTimeout(() => hornEl.setAttribute('visible', 'false'), 1000);
            }

            // Física de Velocidade
            if (accelerate) this.speed -= 25 * delta;
            if (brake) this.speed += 18 * delta;
            this.speed *= 0.98; // Atrito suave

            // Curva (Só vira se estiver movendo)
            if (Math.abs(this.speed) > 0.1) {
              this.rotationSpeed -= turnInput * 100 * delta;
            }
            this.rotationSpeed *= 0.90;

            // Aplica no Carro
            let carRot = this.el.getAttribute('rotation');
            carRot.y += this.rotationSpeed * delta;
            this.el.setAttribute('rotation', carRot);

            let carPos = this.el.getAttribute('position');
            const angle = carRot.y * (Math.PI / 180);
            carPos.x += Math.sin(angle) * this.speed * delta;
            carPos.z += Math.cos(angle) * this.speed * delta;
            this.el.setAttribute('position', carPos);

            // --- 2. CÂMERA ORBITAL (Analógico Direito) ---
            // Detecta eixos 2/3 ou 3/4 variando conforme o controle
            let lookH = (Math.abs(gp.axes[2]) > 0.1) ? gp.axes[2] : (Math.abs(gp.axes[3]) > 0.1 && Math.abs(gp.axes[0]) < 0.1 ? gp.axes[3] : 0);
            let lookV = (gp.axes[5] && Math.abs(gp.axes[5]) > 0.1) ? gp.axes[5] : (Math.abs(gp.axes[4]) > 0.1 ? gp.axes[4] : 0);
            
            this.camRotationY -= lookH * 150 * delta;
            this.camRotationX -= lookV * 80 * delta;
            this.camRotationX = Math.max(-40, Math.min(10, this.camRotationX)); // Limita inclinação

            let rig = document.querySelector('#camera-rig');
            rig.setAttribute('rotation', `${this.camRotationX} ${this.camRotationY} 0`);
          }
        }
      });
    </script>

    <a-scene vr-mode-ui="enabled: false">
      
      <a-assets>
        <a-asset-item id="modelo-carro" src="./carro.glb"></a-asset-item>
      </a-assets>

      <a-entity environment="preset: mountaineer; groundColor: #222; grid: dashed; fog: 0.6"></a-entity>

      <a-circle position="0 0.01 0" radius="100" color="#111" rotation="-90 0 0" opacity="0.8"></a-circle>

      <a-text id="horn-ui" value="BEEP BEEP!" position="0 3 -3" color="yellow" align="center" visible="false" scale="2 2 2"></a-text>

      <a-entity id="player" position="0 0 0" drive-car>
        
        <a-entity gltf-model="#modelo-carro" scale="1 1 1" rotation="0 180 0">
            <a-light type="spot" color="white" intensity="0.8" position="0.5 0.5 -1" rotation="0 180 0"></a-light>
            <a-light type="spot" color="white" intensity="0.8" position="-0.5 0.5 -1" rotation="0 180 0"></a-light>
        </a-entity>

        <a-entity id="camera-rig">
           <a-entity camera position="0 3.2 7.5" look-controls="enabled: false"></a-entity>
        </a-entity>

      </a-entity>

      <a-torus-knot position="10 3 -20" color="orange" radius="2"></a-torus-knot>
      <a-box position="-15 1 -40" color="red" width="4" height="4" depth="4"></a-box>
      <a-sphere position="20 1 10" color="blue" radius="3"></a-sphere>

    </a-scene>

    <div style="position: fixed; bottom: 20px; width: 100%; text-align: center; color: white; font-family: sans-serif; pointer-events: none; text-shadow: 2px 2px black;">
        Analógico Esq: Dirigir | Analógico Dir: Olhar | R2: Correr | L2: Frear | X: Freio de Mão | Y: Reset Cam | A: Buzina
    </div>

  </body>
</html>
