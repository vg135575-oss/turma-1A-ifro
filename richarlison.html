<!DOCTYPE html>
<html>
  <head>
    <title>Richarlison Racer - Full Controller</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  </head>
  <body>
    
    <script>
      AFRAME.registerComponent('drive-car', {
        init: function () {
          this.speed = 0;
          this.rotationSpeed = 0;
          this.camRotationY = 0; // Rotação da câmera
          this.camRotationX = 0; 
          
          this.keys = { up: false, down: false, left: false, right: false };

          window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = true;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = true;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = true;
          });

          window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = false;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = false;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = false;
          });
        },

        tick: function (time, timeDelta) {
          const delta = timeDelta / 1000;
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          const gp = gamepads[0];

          // --- CONTROLES DE MOVIMENTO (Esquerdo / Botões) ---
          let gpAccelerate = gp?.buttons[0].pressed || this.keys.up;
          let gpBrake = gp?.buttons[1].pressed || this.keys.down;
          let gpTurn = (gp ? gp.axes[0] : 0) + (this.keys.left ? -1 : 0) + (this.keys.right ? 1 : 0);

          if (gpAccelerate) this.speed -= 18 * delta;
          if (gpBrake) this.speed += 12 * delta;
          this.speed *= 0.96;

          if (Math.abs(this.speed) > 0.1) {
            this.rotationSpeed -= gpTurn * 70 * delta;
          }
          this.rotationSpeed *= 0.90;

          // Aplica Movimento ao Carro
          let carRot = this.el.getAttribute('rotation');
          carRot.y += this.rotationSpeed * delta;
          this.el.setAttribute('rotation', carRot);

          let carPos = this.el.getAttribute('position');
          const angle = carRot.y * (Math.PI / 180);
          carPos.x += Math.sin(angle) * this.speed * delta;
          carPos.z += Math.cos(angle) * this.speed * delta;
          this.el.setAttribute('position', carPos);

          // --- CONTROLE DA CÂMERA (Analógico Direito) ---
          if (gp) {
            // Eixo 2 e 3 são geralmente o analógico direito
            let lookX = gp.axes[2]; // Horizontal
            let lookY = gp.axes[3]; // Vertical

            if (Math.abs(lookX) > 0.1) this.camRotationY -= lookX * 100 * delta;
            if (Math.abs(lookY) > 0.1) this.camRotationX -= lookY * 50 * delta;

            // Limitar rotação vertical para não virar de ponta cabeça
            this.camRotationX = Math.max(-30, Math.min(20, this.camRotationX));

            let rig = document.querySelector('#camera-rig');
            rig.setAttribute('rotation', `${this.camRotationX} ${this.camRotationY} 0`);
          }
        }
      });
    </script>

    <a-scene background="color: #87CEEB">
      <a-assets>
        <a-asset-item id="modelo-carro" src="./carro.glb"></a-asset-item>
        <img id="grama" src="https://cdn.aframe.io/a-painter/images/floor.jpg">
      </a-assets>

      <a-plane src="#grama" rotation="-90 0 0" width="500" height="500" repeat="50 50"></a-plane>
      
      <a-entity id="player" position="0 0 0" drive-car>
        <a-entity gltf-model="#modelo-carro" scale="1 1 1" rotation="0 180 0"></a-entity>

        <a-entity id="camera-rig" position="0 0 0">
           <a-entity camera position="0 2.5 6" look-controls="enabled: false"></a-entity>
        </a-entity>
      </a-entity>

      <a-box position="-10 1 -20" color="red"></a-box>
      <a-box position="10 1 -40" color="green"></a-box>
    </a-scene>
  </body>
</html>
