<!DOCTYPE html>
<html>
  <head>
    <title>Richarlison Racer - Night City Edition</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
  </head>
  <body>
    
    <script>
      AFRAME.registerComponent('drive-car', {
        init: function () {
          // Configurações de Dirigibilidade
          this.maxSpeed = 20;
          this.accel = 18;
          this.friction = 0.98;
          this.turnSpeed = 90;
          
          this.currentSpeed = 0;
          this.currentTurn = 0;
          this.camRotationY = 0; 
          this.camRotationX = 0; 
          
          this.keys = { up: false, down: false, left: false, right: false };

          window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = true;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = true;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = true;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = true;
          });

          window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowUp' || e.key === 'w') this.keys.up = false;
            if (e.key === 'ArrowDown' || e.key === 's') this.keys.down = false;
            if (e.key === 'ArrowLeft' || e.key === 'a') this.keys.left = false;
            if (e.key === 'ArrowRight' || e.key === 'd') this.keys.right = false;
          });
        },

        applyDeadzone: function(value) {
            return Math.abs(value) < 0.15 ? 0 : value;
        },

        lerp: function(start, end, amt) {
            return (1 - amt) * start + amt * end;
        },

        tick: function (time, timeDelta) {
          const delta = timeDelta / 1000;
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          const gp = Object.values(gamepads).find(g => g !== null);

          // Inputs
          let gasInput = this.keys.up || (gp && gp.buttons[0].pressed);
          let brakeInput = this.keys.down || (gp && gp.buttons[1].pressed);
          
          let turnInput = 0;
          if (this.keys.left) turnInput = -1;
          if (this.keys.right) turnInput = 1;
          if (gp) turnInput += this.applyDeadzone(gp.axes[0]);

          // Lógica de Movimento
          if (gasInput) this.currentSpeed -= this.accel * delta;
          else if (brakeInput) this.currentSpeed += this.accel * delta;
          
          this.currentSpeed *= this.friction;

          // Curva
          if (Math.abs(this.currentSpeed) > 0.2) {
            let direction = this.currentSpeed < 0 ? 1 : -1;
            let targetTurn = turnInput * this.turnSpeed * direction;
            this.currentTurn = this.lerp(this.currentTurn, targetTurn, 5 * delta);

            let carRot = this.el.getAttribute('rotation');
            carRot.y -= this.currentTurn * delta;
            this.el.setAttribute('rotation', carRot);
          }

          // Aplicar Posição (O kinematic-body usará isso para detectar colisão)
          let carRot = this.el.getAttribute('rotation');
          let carPos = this.el.getAttribute('position');
          const angle = carRot.y * (Math.PI / 180);
          
          carPos.x += Math.sin(angle) * this.currentSpeed * delta;
          carPos.z += Math.cos(angle) * this.currentSpeed * delta;
          this.el.setAttribute('position', carPos);

          // Câmera com Analógico Direito
          if (gp) {
            let lookX = this.applyDeadzone(gp.axes[2]);
            let lookY = this.applyDeadzone(gp.axes[3]);
            this.camRotationY -= lookX * 100 * delta;
            this.camRotationX -= lookY * 60 * delta;
            this.camRotationX = Math.max(-20, Math.min(30, this.camRotationX));
            document.querySelector('#camera-rig').setAttribute('rotation', `${this.camRotationX} ${this.camRotationY} 0`);
          }
        }
      });
    </script>

    <a-scene physics="debug: false; gravity: -9.8" background="color: #000510">
      
      <a-assets>
        <a-asset-item id="modelo-carro" src="./carro.glb"></a-asset-item>
        <a-asset-item id="modelo-cidade" src="./City_at_night.glb"></a-asset-item>
      </a-assets>

      <a-entity light="type: ambient; color: #555; intensity: 0.5"></a-entity>
      <a-entity light="type: directional; color: #fff; intensity: 0.8" position="-1 10 1"></a-entity>

      <a-entity 
        gltf-model="#modelo-cidade" 
        position="0 0 0" 
        static-body="shape: mesh">
      </a-entity>

      <a-plane rotation="-90 0 0" width="1000" height="1000" visible="false" static-body></a-plane>

      <a-entity id="player" 
                position="0 0.5 0" 
                drive-car 
                kinematic-body>
        
        <a-entity gltf-model="#modelo-carro" scale="1 1 1" rotation="0 180 0"></a-entity>

        <a-entity id="camera-rig" position="0 1.2 0">
           <a-entity camera position="0 1.5 5" look-controls="enabled: false"></a-entity>
        </a-entity>
      </a-entity>

    </a-scene>
  </body>
</html>
