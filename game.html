<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Bird Runner - Vers√£o Completa (Acode)</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#ffd8b3;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  canvas{display:block}

  /* HUD */
  #score{position:fixed;top:10px;left:50%;transform:translateX(-50%);font-size:34px;color:#fff;font-weight:800;z-index:20;
         text-shadow:0 3px 10px rgba(0,0,0,.6);display:none;padding:6px 14px;border-radius:12px;background:rgba(0,0,0,0.18);}
  #coinCounter{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-size:22px;color:#ffdd00;font-weight:800;z-index:20;
         text-shadow:0 3px 10px rgba(0,0,0,.6);display:none;padding:6px 12px;border-radius:12px;background:rgba(0,0,0,0.14);}
  #record{position:fixed;right:12px;top:12px;color:#fff;font-weight:700;z-index:20;text-shadow:0 2px 8px rgba(0,0,0,.5);display:none}

  /* Screens */
  .screen{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,0.45);z-index:9999;color:#fff}
  .screen.show{display:grid}
  .box{background:rgba(255,255,255,0.04);padding:22px;border-radius:16px;min-width:260px;max-width:92%;text-align:center;
       box-shadow:0 12px 30px rgba(0,0,0,.5);backdrop-filter:blur(6px)}
  h1{margin:0 0 6px 0;font-size:26px}
  .hint{font-size:13px;opacity:.95}
  button{margin-top:14px;padding:12px 26px;border-radius:14px;border:none;background:#ff2d6f;color:white;font-weight:800;font-size:16px}
  button:active{transform:scale(.98)}

  /* small control buttons */
  #pauseBtn{position:fixed;left:12px;top:12px;z-index:20;padding:10px 12px;border-radius:10px;border:none;background:rgba(0,0,0,0.28);color:#fff;font-weight:800}
  #pauseBtn:active{transform:scale(.97)}
  #resumeBtn{margin-top:10px;padding:8px 18px;border-radius:12px;border:none;background:#3bcf7f;color:#fff;font-weight:700}

  /* hint to tap audio */
  #audioHint{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);z-index:25;background:rgba(0,0,0,0.35);color:#fff;padding:8px 12px;border-radius:12px;font-size:13px;display:none}
</style>
</head>
<body>

  <div id="score">0</div>
  <div id="coinCounter">Moedas: 0</div>
  <div id="record">üèÜ Recorde: 0</div>

  <button id="pauseBtn" style="display:none">Pausar</button>
  <div id="audioHint">Toque na tela para ativar som</div>

  <div id="startScreen" class="screen show">
    <div class="box">
      <h1>üê¶ Bird Runner</h1>
      <div class="hint">Deslize para os lados para mudar de pista. Deslize pra cima para pular.</div>
      <div style="height:8px"></div>
      <button id="startBtn">JOGAR</button>
      <div style="height:8px"></div>
      <div class="hint" style="opacity:.8;font-size:12px">Vers√£o otimizada para celular (4 GB)</div>
    </div>
  </div>

  <div id="pauseScreen" class="screen">
    <div class="box">
      <h1>‚è∏ PAUSADO</h1>
      <button id="resumeBtn">CONTINUAR</button>
    </div>
  </div>

  <div id="gameOverScreen" class="screen">
    <div class="box">
      <h1>üí• GAME OVER</h1>
      <div id="finalScore" style="margin-top:8px;font-size:18px;font-weight:700"></div>
      <div style="height:8px"></div>
      <button id="restartBtn">RECOME√áAR</button>
    </div>
  </div>

<script type="module">
// =========================
// Bird Runner - full optimized single-file
// Works well on Acode (Android / mobile) - optimized for 4GB RAM
// Features: dynamic sky, fog, particles (dust + coin sparkles), powerups visual, sounds (external), pause, record saved to localStorage
// =========================

import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

/* -------------------------
   CONFIG / AUDIO LINKS
   ------------------------- */
// Replace these URLs if any doesn't load for you.
// Prefer small .mp3 or .ogg files hosted on GitHub/rawcdn or your server.
const AUDIO_URLS = {
  wind: "https://cdn.freesound.org/previews/341/341695_6263980-lq.mp3",      // example (may need replacing)
  coin: "https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg",
  hit:  "https://actions.google.com/sounds/v1/cartoon/boing.ogg"
};

// Toggle audio on/off at runtime
let audioEnabled = true;

/* -------------------------
   GLOBALS
------------------------- */
let scene, camera, renderer;
let bird, obstacles = [], coins = [], powerUps = [], roadSegments = [], buildings = [], palms = [];
let dustGeo, dustSystem, dustPositions, dustLife;
let coinSparkGeo, coinSparkSystem, coinSparkPositions, coinSparkLife;
let velocityY = 0, isJumping = false, isGameOver = false, score = 0;
let boostTime = 0, shieldTime = 0, multiplierTime = 0, coinCount = 0;
const lanes = [-4.2,0,4.2];
let targetLane = 1, swipeStart = null, hasSwiped=false, gameStarted=false, paused=false;
let scoreElem = document.getElementById('score'), coinCounterElem = document.getElementById('coinCounter'), recordElem = document.getElementById('record');

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const audioBuffers = {}; // loaded audio

/* -------------------------
   UTILS
------------------------- */
function loadAudio(url, key){
  return fetch(url).then(r=>r.arrayBuffer()).then(b=>audioCtx.decodeAudioData(b)).then(buf=>{ audioBuffers[key]=buf; }).catch(()=>{ console.warn("Audio failed:", url); });
}
function playSound(key, volume=0.6){
  if(!audioEnabled) return;
  const buf = audioBuffers[key];
  if(!buf) return;
  const s = audioCtx.createBufferSource();
  s.buffer = buf;
  const gain = audioCtx.createGain();
  gain.gain.value = volume;
  s.connect(gain); gain.connect(audioCtx.destination);
  s.start(0);
}

/* -------------------------
   BIRD CREATION
------------------------- */
function createBird(){
  const g = new THREE.Group();
  const body = new THREE.Mesh(new THREE.SphereGeometry(.42,12,12), new THREE.MeshBasicMaterial({color:0xffe36b}));
  const beak = new THREE.Mesh(new THREE.ConeGeometry(.16,.36,8), new THREE.MeshBasicMaterial({color:0xff7a2d}));
  beak.position.set(0,0,.46); beak.rotation.x = Math.PI/2;
  const wing1 = new THREE.Mesh(new THREE.BoxGeometry(.8,.06,.34), new THREE.MeshBasicMaterial({color:0xffe36b}));
  const wing2 = wing1.clone();
  wing1.position.set(.36,.08,0); wing2.position.set(-.36,.08,0);
  // shield visual (ring)
  const shield = new THREE.Mesh(new THREE.RingGeometry(.55,.7,24), new THREE.MeshBasicMaterial({color:0x44ccff,transparent:true,opacity:0.25,side:THREE.DoubleSide}));
  shield.rotation.x = Math.PI/2; shield.position.set(0,1.85,0);
  shield.visible = false;
  shield.name = "shieldRing";
  g.add(body,beak,wing1,wing2,shield);
  g.position.set(0,2,0);
  return g;
}

/* -------------------------
   PARTICLES (dust and coin sparks)
------------------------- */
function initParticles(scene){
  // dust (behind bird)
  const dustCount = 120;
  dustGeo = new THREE.BufferGeometry();
  dustPositions = new Float32Array(dustCount*3);
  dustLife = new Float32Array(dustCount);
  for(let i=0;i<dustCount;i++){ dustPositions[i*3]=0; dustPositions[i*3+1]=-10; dustPositions[i*3+2]=0; dustLife[i]=0; }
  dustGeo.setAttribute('position', new THREE.BufferAttribute(dustPositions,3));
  const dustMat = new THREE.PointsMaterial({size:0.06,transparent:true,opacity:0.55});
  dustSystem = new THREE.Points(dustGeo,dustMat);
  scene.add(dustSystem);

  // coin sparks
  const sparkCount = 80;
  coinSparkGeo = new THREE.BufferGeometry();
  coinSparkPositions = new Float32Array(sparkCount*3);
  coinSparkLife = new Float32Array(sparkCount);
  for(let i=0;i<sparkCount;i++){ coinSparkPositions[i*3]=0; coinSparkPositions[i*3+1]=-10; coinSparkPositions[i*3+2]=0; coinSparkLife[i]=0; }
  coinSparkGeo.setAttribute('position', new THREE.BufferAttribute(coinSparkPositions,3));
  const sparkMat = new THREE.PointsMaterial({size:0.08,transparent:true,opacity:0.95});
  coinSparkSystem = new THREE.Points(coinSparkGeo,sparkMat);
  scene.add(coinSparkSystem);
}

/* -------------------------
   SCENE BUILD
------------------------- */
function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffd3a3);
  scene.fog = new THREE.FogExp2(0xffd3a3, 0.007);

  camera = new THREE.PerspectiveCamera(72, innerWidth/innerHeight, 0.1, 3000);
  camera.position.set(0,6,12);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio( Math.min(1, window.devicePixelRatio || 1) );
  renderer.shadowMap.enabled = false;
  document.body.appendChild(renderer.domElement);

  // ambient "light" (we use BasicMaterial so this is mostly aesthetic)
  scene.add(new THREE.AmbientLight(0xffffff, 1.0));

  // road segments
  const roadMat = new THREE.MeshBasicMaterial({color:0xe2a07a});
  for(let i=0;i<20;i++){
    const seg = new THREE.Mesh(new THREE.PlaneGeometry(18,20), roadMat);
    seg.rotation.x = -Math.PI/2;
    seg.position.set(0,0,-i*20);
    scene.add(seg);
    roadSegments.push(seg);
  }

  // rails
  for(let laneIndex=0;laneIndex<lanes.length;laneIndex++){
    const x = lanes[laneIndex];
    const left = new THREE.Mesh(new THREE.BoxGeometry(.08,.04,2000), new THREE.MeshBasicMaterial({color:0x555555}));
    const right = new THREE.Mesh(new THREE.BoxGeometry(.08,.04,2000), new THREE.MeshBasicMaterial({color:0x555555}));
    left.position.set(x-0.6,0.02,-900); right.position.set(x+0.6,0.02,-900);
    scene.add(left,right);
  }

  // bird
  bird = createBird();
  scene.add(bird);

  // obstacles
  for(let i=0;i<18;i++){
    addObstacle(Math.floor(Math.random()*3), -i*28 - 30);
  }

  // coins
  for(let i=0;i<20;i++){
    addCoin(lanes[Math.floor(Math.random()*3)], 1.8 + Math.random()*0.6, -i*40 - 18);
  }

  // powerups (visuals are simple colored spheres)
  const types = ['boost','shield','multiplier','jump'];
  for(let i=0;i<8;i++){
    const t = types[Math.floor(Math.random()*types.length)];
    addPowerUp(t, Math.floor(Math.random()*3), -i*110 - 60);
  }

  // buildings & palms (reduced count)
  for(let i=0;i<18;i++){
    const side = (i%2===0)?-1:1;
    addBuilding(side, 4 + Math.random()*8, 2 + Math.random()*1.2, 2 + Math.random()*1.6, -i*20 - 10);
    addPalmTree(side*(6 + Math.random()*1.2), -i*25 - 8);
  }

  // particles
  initParticles(scene);

  // UI binds
  scoreElem = document.getElementById('score'); coinCounterElem = document.getElementById('coinCounter'); recordElem=document.getElementById('record');
  document.getElementById('startBtn').onclick = startGame;
  document.getElementById('restartBtn').onclick = restartGame;
  document.getElementById('pauseBtn').onclick = togglePause;
  document.getElementById('resumeBtn').onclick = togglePause;

  // touch events
  window.addEventListener('touchstart', onTouchStart, {passive:true});
  window.addEventListener('touchmove', onTouchMove, {passive:true});
  window.addEventListener('touchend', onTouchEnd, {passive:true});
  window.addEventListener('resize', onResize);

  // load audio asynchronously (non-blocking)
  loadAudio(AUDIO_URLS.wind, 'wind').then(()=>{ if(audioEnabled) playSound('wind', 0.25); });
  loadAudio(AUDIO_URLS.coin, 'coin');
  loadAudio(AUDIO_URLS.hit, 'hit');

  // show record if exists
  const r = parseInt(localStorage.getItem('birdrunner_high') || '0',10);
  recordElem.textContent = `üèÜ Recorde: ${r}`;
  recordElem.style.display = 'block';
}
init();

/* -------------------------
   OBJECT ADDERS
------------------------- */
function addObstacle(laneIndex,zPos){
  const geo = new THREE.BoxGeometry(2.2,2.4,8);
  const mat = new THREE.MeshBasicMaterial({color: Math.floor(Math.random()*0xffffff)});
  const obs = new THREE.Mesh(geo,mat);
  obs.position.set(lanes[laneIndex], 1.2, zPos);
  scene.add(obs); obstacles.push(obs);
}
function addCoin(x,y,z){
  const geo = new THREE.TorusGeometry(0.22,0.05,8,20);
  const mat = new THREE.MeshBasicMaterial({color:0xffdd00});
  const coin = new THREE.Mesh(geo,mat);
  coin.position.set(x,y,z); coin.rotation.x = Math.PI/2;
  scene.add(coin); coins.push(coin);
}
function addPowerUp(type, laneIndex, zPos){
  const colorMap = { boost:0xff8c42, shield:0x44ccff, jump:0xff66cc, multiplier:0xffff66 };
  const geo = new THREE.SphereGeometry(0.42,10,10);
  const mat = new THREE.MeshBasicMaterial({color: colorMap[type]||0x00aaff});
  const pu = new THREE.Mesh(geo,mat);
  pu.position.set(lanes[laneIndex],1.55,zPos); pu.userData={type};
  scene.add(pu); powerUps.push(pu);
}
function addBuilding(side,height,width,depth,zPos){
  const mat = new THREE.MeshBasicMaterial({color: Math.floor(Math.random()*0xffffff)});
  const b = new THREE.Mesh(new THREE.BoxGeometry(width,height,depth), mat);
  b.position.set(side*7.5, height/2, zPos);
  scene.add(b); buildings.push(b);
}
function addPalmTree(x,z){
  const trunk = new THREE.Mesh(new THREE.CylinderGeometry(.12,.18,2.2,6), new THREE.MeshBasicMaterial({color:0x8b5a2b}));
  trunk.position.set(x,1.1,z);
  const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.1,1.6,6), new THREE.MeshBasicMaterial({color:0x16a34a}));
  leaves.position.set(x,2.2,z);
  scene.add(trunk,leaves); palms.push(trunk,leaves);
}

/* -------------------------
   INPUT
------------------------- */
function onTouchStart(e){
  // allow a tap to enable audio context in mobile browsers
  document.getElementById('audioHint').style.display = 'none';
  if(audioCtx.state === 'suspended'){ audioCtx.resume(); }

  swipeStart = {x:e.touches[0].clientX, y:e.touches[0].clientY};
  hasSwiped = false;
}
function onTouchMove(e){
  if(!swipeStart || hasSwiped || !gameStarted || paused) return;
  const deltaX = e.touches[0].clientX - swipeStart.x;
  const deltaY = swipeStart.y - e.touches[0].clientY;
  if(deltaY > 40 && !isJumping){ velocityY = 0.78; isJumping=true; hasSwiped=true; spawnDust(10); playSound('wind',0.12); }
  if(deltaX > 40 && targetLane < lanes.length-1){ targetLane++; hasSwiped=true; }
  else if(deltaX < -40 && targetLane > 0){ targetLane--; hasSwiped=true; }
}
function onTouchEnd(){ swipeStart=null; hasSwiped=false; }

/* -------------------------
   GAME CONTROL
------------------------- */
function startGame(){
  document.getElementById('startScreen').classList.remove('show');
  document.getElementById('pauseBtn').style.display = 'block';
  scoreElem.style.display = 'block'; coinCounterElem.style.display = 'block';
  gameStarted = true; paused=false;
}
function togglePause(){
  paused = !paused;
  document.getElementById('pauseScreen').classList.toggle('show', paused);
  document.getElementById('pauseBtn').textContent = paused ? 'Retomar' : 'Pausar';
}
function restartGame(){
  document.getElementById('gameOverScreen').classList.remove('show');
  bird.position.set(0,2,0); velocityY=0; isJumping=false; targetLane=1;
  score=0; coinCount=0; boostTime=shieldTime=multiplierTime=0; isGameOver=false; gameStarted=true;
  scoreElem.textContent = '0'; coinCounterElem.textContent = `Moedas: 0`;
}

/* -------------------------
   PARTICLE SPAWN HELPERS
------------------------- */
function spawnDust(n){
  // find n dead dust and place behind bird
  for(let i=0;i<dustLife.length && n>0;i++){
    if(dustLife[i] <= 0){
      dustLife[i] = 18 + Math.random()*12;
      const idx = i*3;
      dustPositions[idx] = bird.position.x + (Math.random()*0.6 - 0.3) - 0.15;
      dustPositions[idx+1] = 1.1 + Math.random()*0.2;
      dustPositions[idx+2] = bird.position.z + 0.6 + Math.random()*0.6;
      n--;
    }
  }
}
function spawnSparks(x,y,z){
  for(let i=0;i<coinSparkLife.length;i++){
    if(coinSparkLife[i] <= 0){
      coinSparkLife[i] = 18 + Math.random()*12;
      const idx = i*3;
      coinSparkPositions[idx] = x + (Math.random()-0.5)*0.8;
      coinSparkPositions[idx+1] = y + Math.random()*0.6;
      coinSparkPositions[idx+2] = z + (Math.random()-0.5)*0.6;
      if(--(i) < 0) break;
    }
  }
}

/* -------------------------
   UPDATE LOOP
------------------------- */
function animate(){
  requestAnimationFrame(animate);
  if(!gameStarted || paused || isGameOver) return;

  // dynamic sky color (time based)
  const t = performance.now() * 0.00006; // slow
  // cycle 0..1
  const cycle = (t % 1);
  // morning -> day -> sunset -> night blending
  let skyColor;
  if(cycle < 0.35) { // morning -> day
    skyColor = lerpColor(0xffcfa6, 0xfff6d9, cycle/0.35);
  } else if(cycle < 0.7) { // day -> sunset
    skyColor = lerpColor(0xfff6d9, 0xffb07a, (cycle-0.35)/0.35);
  } else { // sunset -> night
    skyColor = lerpColor(0xffb07a, 0x6b4b7b, (cycle-0.7)/0.3);
  }
  scene.background = new THREE.Color(skyColor);
  scene.fog.color = new THREE.Color(skyColor);

  // speeds
  let baseSpeed = 0.38 + Math.min(score/700, 0.65);
  if(boostTime>0) { baseSpeed += 0.48; boostTime--; }
  if(shieldTime>0) shieldTime--;
  if(multiplierTime>0) multiplierTime--;

  // bird movement
  bird.position.z -= baseSpeed;
  bird.position.y += velocityY;
  velocityY -= 0.048;
  if(bird.position.y <= 1.85){ bird.position.y=1.85; isJumping=false; velocityY=0; }

  // wing flap
  const flap = Math.sin(Date.now()*0.012) * 0.35;
  if(bird.children[2]) bird.children[2].rotation.z = flap;
  if(bird.children[3]) bird.children[3].rotation.z = -flap;

  // camera follow
  const desiredCam = new THREE.Vector3(bird.position.x, bird.position.y + 5, bird.position.z + 10);
  camera.position.lerp(desiredCam, 0.08);
  camera.lookAt(new THREE.Vector3(bird.position.x, bird.position.y+1.4, bird.position.z - 5));

  // lateral smooth
  const dx = lanes[targetLane] - bird.position.x;
  bird.position.x += Math.sign(dx) * Math.min(Math.abs(dx), 0.22);

  // obstacles logic and collision
  obstacles.forEach(obs=>{
    if(obs.position.z > bird.position.z + 12){
      obs.position.z = bird.position.z - (260 + Math.random()*200);
      obs.position.x = lanes[Math.floor(Math.random()*3)];
    }
    const distX = Math.abs(obs.position.x - bird.position.x);
    const distY = Math.abs(obs.position.y - bird.position.y);
    const distZ = Math.abs(obs.position.z - bird.position.z);
    if(distX < 1.0 && distY < 1.3 && distZ < 2.0 && shieldTime <= 0){
      // hit
      playSound('hit',0.8);
      doGameOver();
    } else if(distX < 1.0 && distY < 1.3 && distZ < 2.0 && shieldTime > 0){
      // consume shield (if any)
      shieldTime = 0;
      const ring = bird.getObjectByName('shieldRing');
      if(ring) ring.visible=false;
    }
  });

  // coins
  coins.forEach(coin=>{
    coin.rotation.z += 0.18;
    if(coin.position.z > bird.position.z + 12){
      coin.position.z = bird.position.z - (360 + Math.random()*220);
      coin.position.x = lanes[Math.floor(Math.random()*3)];
    }
    const dx2 = coin.position.x - bird.position.x;
    const dy2 = coin.position.y - bird.position.y;
    const dz2 = coin.position.z - bird.position.z;
    if(Math.sqrt(dx2*dx2 + dy2*dy2 + dz2*dz2) < 0.7){
      coinCount++;
      score += (multiplierTime>0 ? 9 : 5);
      coinCounterElem.textContent = `Moedas: ${coinCount}`;
      coin.position.z = bird.position.z - (420 + Math.random()*260);
      spawnSparks(bird.position.x, bird.position.y, bird.position.z - 1.2);
      playSound('coin', 0.9);
    }
  });

  // powerups
  powerUps.forEach(pu=>{
    pu.rotation.y += 0.06;
    if(pu.position.z > bird.position.z + 12){
      pu.position.z = bird.position.z - (880 + Math.random()*420);
      pu.position.x = lanes[Math.floor(Math.random()*3)];
    }
    const dx3 = pu.position.x - bird.position.x;
    const dy3 = pu.position.y - bird.position.y;
    const dz3 = pu.position.z - bird.position.z;
    if(Math.sqrt(dx3*dx3 + dy3*dy3 + dz3*dz3) < 0.95){
      // apply
      const t = pu.userData.type;
      if(t === 'jump') { velocityY = 0.9; isJumping=true; spawnDust(12); playSound('wind',0.14); }
      else if(t === 'boost') { boostTime = 220; }
      else if(t === 'shield') { shieldTime = 220; const ring = bird.getObjectByName('shieldRing'); if(ring) ring.visible=true; }
      else if(t === 'multiplier') { multiplierTime = 300; }
      pu.position.z = bird.position.z - (880 + Math.random()*320);
    }
  });

  // road loop
  roadSegments.forEach(seg=>{
    seg.position.z += baseSpeed;
    if(seg.position.z > bird.position.z + 20) seg.position.z -= roadSegments.length * 20;
  });

  // buildings & palms
  buildings.forEach(b=>{
    b.position.z += baseSpeed * 0.5;
    if(b.position.z > bird.position.z + 60) b.position.z -= buildings.length * 18;
  });
  palms.forEach(p=>{
    p.position.z += baseSpeed * 0.6;
    if(p.position.z > bird.position.z + 60) p.position.z -= palms.length * 25;
  });

  // particles update
  // dust
  for(let i=0;i<dustLife.length;i++){
    if(dustLife[i] > 0){
      dustLife[i]--;
      const idx = i*3;
      dustPositions[idx+2] += baseSpeed * 0.6; // move with world
      dustPositions[idx] += (Math.random()-0.5)*0.02;
      dustPositions[idx+1] -= 0.002;
      if(dustLife[i] < 4) dustPositions[idx+1] -= 0.02;
    } else {
      // hide below scene
      const idx = i*3;
      dustPositions[idx+1] = -10;
    }
  }
  dustGeo.attributes.position.needsUpdate = true;

  // coin sparks
  for(let i=0;i<coinSparkLife.length;i++){
    if(coinSparkLife[i] > 0){
      coinSparkLife[i]--;
      const idx = i*3;
      coinSparkPositions[idx+1] -= 0.02;
      coinSparkPositions[idx] += (Math.random()-0.5)*0.06;
      coinSparkPositions[idx+2] += (Math.random()-0.5)*0.06;
    } else {
      const idx = i*3; coinSparkPositions[idx+1] = -10;
    }
  }
  coinSparkGeo.attributes.position.needsUpdate = true;

  // render
  renderer.render(scene, camera);

  // score
  score += 0.32;
  scoreElem.textContent = Math.floor(score);

  // highscore check
  const prev = parseInt(localStorage.getItem('birdrunner_high')||'0',10);
  if(Math.floor(score) > prev){
    localStorage.setItem('birdrunner_high', Math.floor(score));
    recordElem.textContent = `üèÜ Recorde: ${Math.floor(score)}`;
  }
}
animate();

/* -------------------------
   GAME OVER
------------------------- */
function doGameOver(){
  isGameOver = true;
  gameStarted = false;
  document.getElementById('finalScore').innerText = `Score: ${Math.floor(score)}`;
  document.getElementById('gameOverScreen').classList.add('show');
  playSound('hit', 1.0);
}

/* -------------------------
   HELPERS
------------------------- */
function onResize(){
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
}

function lerpColor(a,b,t){
  // a,b in hex (0x...), returns 0x...
  const ar = (a>>16)&255, ag=(a>>8)&255, ab=a&255;
  const br = (b>>16)&255, bg=(b>>8)&255, bb=b&255;
  const rr = Math.round(ar + (br-ar)*t);
  const rg = Math.round(ag + (bg-ag)*t);
  const rb = Math.round(ab + (bb-ab)*t);
  return (rr<<16) + (rg<<8) + rb;
}
</script>
</body>
</html>